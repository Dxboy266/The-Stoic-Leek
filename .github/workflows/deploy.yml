name: ðŸš€ Build & Deploy

on:
  push:
    branches: [2.0, main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  # å¼ºåˆ¶ä½¿ç”¨å°å†™
  IMAGE_OWNER: dxboy266

jobs:
  # ============ æž„å»ºå¹¶æŽ¨é€é•œåƒ ============
  build:
    name: ðŸ”¨ Build Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: ðŸ“¦ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ” Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ—ï¸ Build & Push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ghcr.io/${{ env.IMAGE_OWNER }}/stoic-leek-backend:latest
      
      - name: ðŸ—ï¸ Build & Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ghcr.io/${{ env.IMAGE_OWNER }}/stoic-leek-frontend:latest
          build-args: |
            NEXT_PUBLIC_API_URL=http://81.70.55.132:8000

  # ============ éƒ¨ç½²åˆ°æœåŠ¡å™¨ ============
  deploy:
    name: ðŸ–¥ï¸ Deploy
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: ðŸš€ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /opt/stoic-leek
            
            # å†™å…¥ docker-compose.yml
            cat > docker-compose.yml << 'COMPOSE'
            version: '3.8'
            services:
              backend:
                image: ghcr.io/dxboy266/stoic-leek-backend:latest
                container_name: stoic-leek-backend
                ports:
                  - "8000:8000"
                volumes:
                  - ./data:/app/data
                  - ./.env:/app/.env
                restart: unless-stopped
            
              frontend:
                image: ghcr.io/dxboy266/stoic-leek-frontend:latest
                container_name: stoic-leek-frontend
                ports:
                  - "3001:3000"
                depends_on:
                  - backend
                restart: unless-stopped
            COMPOSE
            
            # ç™»å½•é•œåƒä»“åº“
            echo "${{ secrets.CR_PAT }}" | docker login ghcr.io -u dxboy266 --password-stdin
            
            # æ‹‰å–å¹¶é‡å¯
            docker-compose pull
            docker-compose up -d --remove-orphans
            docker image prune -f
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            docker-compose ps
